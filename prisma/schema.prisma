// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  VOLUNTEER
  BENEFICIARY
  ORGANIZATION
}

enum UserStatus {
  PENDING
  ACTIVE
  DENIED
  BANNED
}

enum GuardianRelation {
  PARENT
  SPOUSE
  CHILD
  SIBLING
  RELATIVE
  FRIEND
  OTHER
}

// request enum
enum RequestCategory {
  EDUCATION
  MEDICAL
  HOUSE_WORK
  TRANSPORT
  FOOD
  SHELTER
  OTHER
}

// thiet lap hoat dong 
enum RecurrenceType {
  NONE
  DAILY
  WEEKLY
  CUSTOM
}

// request
enum ActivityStatus {
  PENDING
  APPROVED
  ONGOING
  COMPLETED
  CANCELLED
  REJECTED
}

enum VulnerabilityType {
  POOR
  DISABLED
  ELDERLY
  SICKNESS
  ORPHAN
  OTHER
}

enum District {
  QUAN_1
  QUAN_3
  QUAN_4
  QUAN_5
  QUAN_6
  QUAN_7
  QUAN_8
  QUAN_10
  QUAN_11
  QUAN_12

  BINH_TAN
  BINH_THANH
  GO_VAP
  PHU_NHUAN
  TAN_BINH
  TAN_PHU

  TP_THU_DUC

  HUYEN_BINH_CHANH
  HUYEN_CAN_GIO
  HUYEN_CU_CHI
  HUYEN_HOC_MON
  HUYEN_NHA_BE
}

enum Skill {
  TEACHING
  EDUCATION
  MEDICAL
  PSYCHOLOGICAL
  LEGAL
  SOCIAL_WORK
  DISASTER_RELIEF
  FUNDRAISING
  LOGISTICS
  COMMUNICATION
  TRANSLATION
  IT_SUPPORT
}

// 
enum UrgencyLevel {
  STANDARD
  CRITICAL
}

enum OrgStatus {
  PENDING   
  APPROVED  
  REJECTED  
}

// models
model User {
  id           String @id @default(uuid())
  email        String @unique
  phoneNumber  String @unique @map("phone_number")
  passwordHash String @map("password_hash")

  role                Role
  status              UserStatus @default(PENDING)
  createdAt           DateTime   @default(now()) @map("created_at")
  forceChangePassword Boolean    @default(false) @map("force_change_password")

  // 1-1 ng dung
  volunteerProfile     VolunteerProfile?
  bficiaryProfile      BficiaryProfile?
  organizationProfiles OrganizationProfile?

  // 1-n hoat dong
  activitiesRequested   HelpRequest[] @relation("HelpRequester")
  activitiesVolunteered HelpRequest[] @relation("HelpVolunteer")

  reviewsWritten  Review[] @relation("Reviewer")
  reviewsReceived Review[] @relation("ReviewTarget")

  appreciationsSent     Appreciation[] @relation("AppreciationSender")
  appreciationsReceived Appreciation[] @relation("AppreciationReceiver")


  campaigns             Campaign[]             @relation("CampaignOrganization")
  campaignRegistrations CampaignRegistration[] @relation("CampaignVolunteer")

// nay cua tcxh
  volunteersManaged    VolunteerProfile[]    @relation("VolunteerOrganization")
  beneficiariesManaged BficiaryProfile[]     @relation("BeneficiaryOrganization")
  communicationPosts   CommunicationPost[]   @relation("OrgPosts")

  // point
  pointHistory           PointHistory[]        @relation("VolunteerPoints")
  volunteerComments      VolunteerComment[]    @relation("VolunteerComments")
  organizationComments   VolunteerComment[]    @relation("OrgComments")
  certificateTemplates   CertificateTemplate[] @relation("OrgCertTemplates")
  certificatesReceived   IssuedCertificate[]   @relation("VolunteerCertificates")
  certificatesIssued     IssuedCertificate[]   @relation("OrgIssuedCertificates")
}

// profile  tnv
model VolunteerProfile {
  userId String @id @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  fullName  String  @map("full_name")
  avatarUrl String? @map("avatar_url")

  skills             Skill[]    @map("skill")
  experienceYears    Int        @default(0) @map("experience_years")
  bio                String?    @db.Text
  totalThanks        Int        @default(0) @map("total_thanks")
  preferredDistricts District[] @map("preferred_districts")

  cccdFrontFile String? @map("cccd_front_file")
  cccdBackFile  String? @map("cccd_back_file")

  organizationId       String?   @map("organization_id")
  organization         User?     @relation("VolunteerOrganization", fields: [organizationId], references: [id])
  organizationStatus   OrgStatus? @map("organization_status")
  joinedOrganizationAt DateTime? @map("joined_organization_at")

  // point
  points Int @default(0)
}

// profile của ncgd
model BficiaryProfile {
  userId String @id @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  fullName  String  @map("full_name")
  avatarUrl String? @map("avatar_url")

  vulnerabilityType    VulnerabilityType @map("vulnerability_type")
  situationDescription String?           @map("situation_description") @db.Text
  healthCondition      String?           @map("health_condition") @db.Text

  proofFiles    String[] @map("proof_files")
  cccdFrontFile String?  @map("cccd_front_file")
  cccdBackFile  String?  @map("cccd_back_file")

  guardianName     String?           @map("guardian_name")
  guardianPhone    String?           @map("guardian_phone")
  guardianRelation GuardianRelation? @map("guardian_relation")

  organizationId       String?   @map("organization_id")
  organization         User?     @relation("BeneficiaryOrganization", fields: [organizationId], references: [id])
  organizationStatus   OrgStatus? @map("organization_status") 
  joinedOrganizationAt DateTime? @map("joined_organization_at")
}

model HelpRequest {
  id String @id @default(uuid())

  // user
  requesterId String @map("requester_id")
  requester   User   @relation("HelpRequester", fields: [requesterId], references: [id], onDelete: Cascade)

  volunteerId String? @map("volunteer_id")
  volunteer   User?   @relation("HelpVolunteer", fields: [volunteerId], references: [id], onDelete: SetNull)

  acceptedAt DateTime? @map("accepted_at")

  activityType RequestCategory @map("request_category")
  title        String
  description  String?         @db.Text

  urgencyLevel UrgencyLevel @default(STANDARD) @map("urgency_level")

  district      District @map("district")
  addressDetail String   @map("address_detail")

  startDate DateTime  @map("start_date") @db.Date
  endDate   DateTime? @map("end_date") @db.Date

  startTime DateTime @map("start_time") @db.Time
  endTime   DateTime @map("end_time") @db.Time

  recurrence RecurrenceType @default(NONE)

  status         ActivityStatus @default(APPROVED)
  activityImages String[]       @map("activity_images")
  createdAt      DateTime       @default(now()) @map("created_at")

  latitude  Float? @map("latitude")
  longitude Float? @map("longitude")

  reviews       Review[]
  appreciations Appreciation[]

  doneAt          DateTime? @map("done_at")
  proofImages     String[]  @map("proof_images")
  completionNotes String?   @map("completion_notes") @db.Text
}

model Review {
  id String @id @default(uuid())

  activityId String      @map("activity_id")
  activity   HelpRequest @relation(fields: [activityId], references: [id], onDelete: Cascade)

  reviewerId String @map("reviewer_id")
  reviewer   User   @relation("Reviewer", fields: [reviewerId], references: [id], onDelete: Cascade)

  targetId String @map("target_id")
  target   User   @relation("ReviewTarget", fields: [targetId], references: [id], onDelete: Cascade)

  rating    Int // 1-5
  comment   String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")
}

model Appreciation {
  id String @id @default(uuid())

  senderId String @map("sender_id")
  sender   User   @relation("AppreciationSender", fields: [senderId], references: [id], onDelete: Cascade)

  receiverId String @map("receiver_id")
  receiver   User   @relation("AppreciationReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  activityId String      @map("activity_id")
  activity   HelpRequest @relation(fields: [activityId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([senderId, activityId])
}

// moi them
enum CampaignStatus {
  PENDING    
  APPROVED   
  REJECTED   
  ONGOING    
  COMPLETED  
  CANCELLED  
}

enum RegistrationStatus {
  REGISTERED  
  ATTENDED    
  CANCELLED   
}

model OrganizationProfile {
  userId String @id @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  organizationName   String  @map("organization_name")
  avatarUrl          String? @map("avatar_url")
  representativeName String  @map("representative_name")

  description String? @db.Text
  website     String?

  district      District @map("district")
  addressDetail String   @map("address_detail")

  businessLicense  String?  @map("business_license")
  verificationDocs String[] @map("verification_docs")

  totalCampaigns  Int @default(0) @map("total_campaigns")
  totalVolunteers Int @default(0) @map("total_volunteers")

  createdAt DateTime @default(now()) @map("created_at")
}

model Campaign {
  id String @id @default(uuid())

  organizationId String @map("organization_id")
  organization   User   @relation("CampaignOrganization", fields: [organizationId], references: [id], onDelete: Cascade)

  status CampaignStatus @default(PENDING)

  title       String
  description String? @db.Text
  goal        String? @db.Text


  district      District @map("district")
  addressDetail String   @map("address_detail")

  // Ttg
  startDate DateTime  @map("start_date")
  endDate   DateTime? @map("end_date")

  // anh
  coverImage String?  @map("cover_image")
  images     String[] @map("images")

  targetVolunteers  Int @default(0) @map("target_volunteers")
  maxVolunteers     Int @default(0) @map("max_volunteers")
  currentVolunteers Int @default(0) @map("current_volunteers")

  registrations CampaignRegistration[]

  // Minh chứng hoàn thành và thời gian hoàn thành
  proofImages String[]  @default([]) @map("proof_images")
  doneAt      DateTime? @map("done_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
}

model CampaignRegistration {
  id String @id @default(uuid())

  campaignId String   @map("campaign_id")
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  volunteerId String @map("volunteer_id")
  volunteer   User   @relation("CampaignVolunteer", fields: [volunteerId], references: [id], onDelete: Cascade)

  status       RegistrationStatus @default(REGISTERED)
  registeredAt DateTime           @default(now()) @map("registered_at")
  notes        String?            @db.Text

  @@unique([campaignId, volunteerId])
}

model CommunicationPost {
  id String @id @default(uuid())

  organizationId String @map("organization_id")
  organization   User   @relation("OrgPosts", fields: [organizationId], references: [id], onDelete: Cascade)

  title      String
  content    String  @db.Text
  coverImage String? @map("cover_image")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("communication_posts")
}


// cộng điểm
enum PointSource {
  HELP_REQUEST 
  CAMPAIGN     
  MANUAL       
  BONUS        
}


// diem -track
model PointHistory {
  id String @id @default(uuid())

  volunteerId String @map("volunteer_id")
  volunteer   User   @relation("VolunteerPoints", fields: [volunteerId], references: [id], onDelete: Cascade)

  points      Int 
  source      PointSource
  description String? @db.Text

  helpRequestId String? @map("help_request_id")
  campaignId    String? @map("campaign_id")

  createdAt DateTime @default(now()) @map("created_at")

  // Prevent duplicate points for the same activity
  @@unique([volunteerId, helpRequestId, source])
  @@unique([volunteerId, campaignId, source])
  @@map("point_history")
}

// nhan xet tcxh - tnv
model VolunteerComment {
  id String @id @default(uuid())

  volunteerId String @map("volunteer_id")
  volunteer   User   @relation("VolunteerComments", fields: [volunteerId], references: [id], onDelete: Cascade)

  // NULL = Admin comment
  organizationId String? @map("organization_id")
  organization   User?   @relation("OrgComments", fields: [organizationId], references: [id], onDelete: Cascade)

  comment String @db.Text
  rating  Int? // 1-5 sao (optional)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("volunteer_comments")
}

// 3. Mẫu chứng nhận của TCXH
model CertificateTemplate {
  id String @id @default(uuid())

  // NULL = system default template (của Admin)
  organizationId String? @map("organization_id")
  organization   User?   @relation("OrgCertTemplates", fields: [organizationId], references: [id], onDelete: Cascade)

  name        String // Tên mẫu: "Chứng nhận xuất sắc", "Chứng nhận tham gia"
  description String? @db.Text

  // URL ảnh template đã upload lên Cloudinary
  templateImageUrl String @map("template_image_url")

  // Cấu hình text box để điền tên TNV (JSON)
  // {
  //   "volunteerName": {
  //     "x": 250,        // Vị trí X (pixel từ góc trái trên)
  //     "y": 300,        // Vị trí Y (pixel từ góc trái trên)
  //     "width": 400,    // Độ rộng text box
  //     "height": 80,    // Độ cao text box
  //     "fontSize": 32,  // Cỡ chữ
  //     "fontFamily": "Arial",
  //     "color": "#000000",
  //     "align": "center" // left, center, right
  //   },
  //   "points": { ... },       // Optional - hiển thị điểm
  //   "issueDate": { ... },    // Optional - ngày cấp
  //   "organizationName": { ... } // Optional - tên tổ chức
  // }
  textBoxConfig Json @map("text_box_config")

  isSystemDefault Boolean  @default(false) @map("is_system_default") // Template mặc định của hệ thống (Admin)
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  issuedCertificates IssuedCertificate[]

  @@map("certificate_templates")
}

// 4. Chứng nhận đã cấp
model IssuedCertificate {
  id String @id @default(uuid())

  templateId String              @map("template_id")
  template   CertificateTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  volunteerId String @map("volunteer_id")
  volunteer   User   @relation("VolunteerCertificates", fields: [volunteerId], references: [id], onDelete: Cascade)

  // NULL = Admin cấp
  organizationId String? @map("organization_id")
  organization   User?   @relation("OrgIssuedCertificates", fields: [organizationId], references: [id], onDelete: Cascade)

  // Thông tin được điền vào chứng nhận (JSON)
  // {
  //   "volunteerName": "Nguyễn Văn A",
  //   "points": 120,
  //   "issueDate": "11/01/2026",
  //   "achievementText": "Đã hoàn thành xuất sắc 12 hoạt động tình nguyện"
  // }
  certificateData Json @map("certificate_data")

  // URL file PDF đã xuất (upload lên Cloudinary)
  pdfUrl String @map("pdf_url")

  // Email tracking
  emailSent   Boolean   @default(false) @map("email_sent")
  emailSentAt DateTime? @map("email_sent_at")

  notes    String?  @db.Text
  issuedAt DateTime @default(now()) @map("issued_at")

  @@map("issued_certificates")
}
