// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  VOLUNTEER
  BENEFICIARY
  ORGANIZATION
}

enum UserStatus {
  PENDING
  ACTIVE
  DENIED
  BANNED
}

enum GuardianRelation {
  PARENT    
  SPOUSE    
  CHILD     
  SIBLING   
  RELATIVE  
  FRIEND    
  OTHER     
}

// activity category
enum RequestCategory {
  EDUCATION   
  MEDICAL     
  HOUSE_WORK  
  TRANSPORT   
  FOOD
  SHELTER
  OTHER      
}

// thiet lap hoat dong 
enum RecurrenceType {
  NONE
  DAILY
  WEEKLY
  CUSTOM
}

// request
enum ActivityStatus {
  PENDING   
  APPROVED  
  ONGOING   
  COMPLETED 
  CANCELLED 
  REJECTED  
}

enum VulnerabilityType {
  POOR      
  DISABLED  
  ELDERLY   
  SICKNESS  
  ORPHAN    
  OTHER     
}

enum District {
  QUAN_1
  QUAN_3
  QUAN_4
  QUAN_5
  QUAN_6
  QUAN_7
  QUAN_8
  QUAN_10
  QUAN_11
  QUAN_12

  BINH_TAN    
  BINH_THANH    
  GO_VAP    
  PHU_NHUAN    
  TAN_BINH    
  TAN_PHU    

  TP_THU_DUC   

  HUYEN_BINH_CHANH
  HUYEN_CAN_GIO
  HUYEN_CU_CHI
  HUYEN_HOC_MON
  HUYEN_NHA_BE
}


enum Skill {
  TEACHING
  EDUCATION         
  MEDICAL           
  PSYCHOLOGICAL     
  LEGAL             
  SOCIAL_WORK       
  DISASTER_RELIEF   
  FUNDRAISING       
  LOGISTICS         
  COMMUNICATION     
  TRANSLATION       
  IT_SUPPORT        
}

// 
enum UrgencyLevel {
  STANDARD
  CRITICAL
}

// models
model User {
  id              String     @id @default(uuid())
  email           String     @unique
  phoneNumber     String     @unique @map("phone_number")
  passwordHash    String     @map("password_hash")
 
  
  role            Role
  status          UserStatus @default(PENDING)
  createdAt           DateTime @default(now()) @map("created_at")
  forceChangePassword Boolean  @default(false) @map("force_change_password")

  // 1-1 Profiles
  volunteerProfile  VolunteerProfile?
  bficiaryProfile   BficiaryProfile?

  // 1-n activity
  activitiesRequested HelpRequest[] @relation("HelpRequester")
  activitiesVolunteered HelpRequest[] @relation("HelpVolunteer")

  reviewsWritten    Review[] @relation("Reviewer")
  reviewsReceived   Review[] @relation("ReviewTarget")

  appreciationsSent     Appreciation[] @relation("AppreciationSender")
  appreciationsReceived Appreciation[] @relation("AppreciationReceiver")

}

// profile của tình nguyện viên
model VolunteerProfile {
  userId             String   @id @map("user_id")
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  fullName        String     @map("full_name")
  avatarUrl       String?    @map("avatar_url")

  skills             Skill[] @map("skill")
  experienceYears    Int      @default(0) @map("experience_years")
  bio                String?  @db.Text
  totalThanks        Int      @default(0) @map("total_thanks")
  preferredDistricts District[] @map("preferred_districts")

  cccdFrontFile   String?    @map("cccd_front_file")
  cccdBackFile    String?    @map("cccd_back_file")
}

// profile của người cần giúp đỡ
model BficiaryProfile {
  userId               String            @id @map("user_id")
  user                 User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  fullName        String     @map("full_name")
  avatarUrl       String?    @map("avatar_url")

  vulnerabilityType    VulnerabilityType @map("vulnerability_type")
  situationDescription String?           @map("situation_description") @db.Text
  healthCondition      String?           @map("health_condition") @db.Text
  
  proofFiles           String[]          @map("proof_files") 
  cccdFrontFile   String?    @map("cccd_front_file")
  cccdBackFile    String?    @map("cccd_back_file")

  guardianName         String?           @map("guardian_name")
  guardianPhone        String?           @map("guardian_phone")
  guardianRelation     GuardianRelation? @map("guardian_relation")

}

model HelpRequest {
  id              String   @id @default(uuid())

  // --- Quan hệ User ---
  requesterId     String   @map("requester_id")
  requester       User     @relation("HelpRequester", fields: [requesterId], references: [id])
  
  volunteerId     String?  @map("volunteer_id")
  volunteer       User?    @relation("HelpVolunteer", fields: [volunteerId], references: [id])
  
  acceptedAt      DateTime? @map("accepted_at")

  // --- Nội dung ---
  activityType    RequestCategory @map("request_category")
  title           String
  description     String?      @db.Text

  // urgency
  urgencyLevel UrgencyLevel @map("urgency_level") @default(STANDARD)
  
  // Địa điểm
  district        District     @map("district")      
  addressDetail   String       @map("address_detail")

  // Thời gian
  startDate       DateTime     @map("start_date") @db.Date
  endDate         DateTime?    @map("end_date")   @db.Date
  
  startTime       DateTime     @map("start_time") @db.Time 
  endTime         DateTime     @map("end_time")   @db.Time 
  
  recurrence      RecurrenceType @default(NONE)

  // System & Images
  status          ActivityStatus @default(PENDING)
  activityImages  String[]       @map("activity_images") 
  createdAt       DateTime       @default(now()) @map("created_at")

  latitude         Float?    @map("latitude")
  longitude        Float?    @map("longitude")

  // Quan hệ ngược
  reviews         Review[]
  appreciations   Appreciation[]

}

model Review {
  id          String   @id @default(uuid())
  
  activityId  String   @map("activity_id")
  activity    HelpRequest @relation(fields: [activityId], references: [id])

  reviewerId  String   @map("reviewer_id")
  reviewer    User     @relation("Reviewer", fields: [reviewerId], references: [id])

  targetId    String   @map("target_id")
  target      User     @relation("ReviewTarget", fields: [targetId], references: [id])

  rating      Int      // 1-5
  comment     String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

}

model Appreciation {
  id          String   @id @default(uuid())

  senderId    String   @map("sender_id")
  sender      User     @relation("AppreciationSender", fields: [senderId], references: [id])

  receiverId  String   @map("receiver_id")
  receiver    User     @relation("AppreciationReceiver", fields: [receiverId], references: [id])

  activityId  String   @map("activity_id")
  activity    HelpRequest @relation(fields: [activityId], references: [id])

  createdAt   DateTime @default(now()) @map("created_at")

  // Ràng buộc duy nhất: 1 Người chỉ được cảm ơn 1 lần cho 1 hoạt động
  @@unique([senderId, activityId])
}